<h1>Giới thiệu</h1>
Hiện nay, với sự phát triển của công nghệ,thì các dự án IOT càng trở nên phổ biến. Và các đồ án của sinh viên cũng càng
ngày càng phát triển theo hướng đó.
Với 1 chút ít kinh nghiệm, chúng tôi sẽ cùng các bạn tiếp cận, tìm hiểu và thực hiện một web server đơn giản cho một dự
án IOT.

Trong phần này chúng ta thực hành sử dụng những gì ta đã học để xây dựng một ứng dụng IOT đơn giả.
<p>
<h1>Yêu cầu 1</h1>
<ul>
    <ol>1. Xây dựng mô hình IOT đơn giản gồm 1 webserver, 1 website, 1 device</ol>
    <ol>2. Webserver trả về website khi truy cập trang chủ.</ol>
    <ol>3. Website là một trang web chứa 1 form có 1 button và 1 check box trạng thái. Khi form submit gửi request bật tắt đèn lên sever. Bật hay tắt do checkbox quy định</ol>
    <ol>4. Device sẵn sàng nhận request từ sever với chu kỳ 1 giây. Khi nhận được request bật tắt đèn, sẽ thay đổi tương ứng</ol>
</ul>
</p>
<p>
<h2>Thiết kê website client</h2>
<div>
Từ yêu cầu trên, ta xây dựng 1 web site đơn giản. Gồm 1 form, với action là 1 địa chỉ cố định và method là post. Trong form chứa 1 check box và 1 button. 
</div>
[code language="html"]
<form action="/led" method="post">
    <p><input type="checkbox" name="status">Bật đèn</input></p>
    <p><button type="submit">submit</button></p> 
</form>
[/code]
</p>
<p>
    <h2>Thiết kế sever</h2>
    Sever xử lý 3 routes. 
    <span style="font-family: 'Courier New'; color:#007241">GET /</span>: Khi người dùng browse tới trang chủ 
    <span style="font-family: 'Courier New'; color:#007241">POST /led</span>: Khi form được submit
    <span style="font-family: 'Courier New'; color:#007241">GET /led</span>: Khi ESP8266 get status điều khiển
    [code language="js"]
    var ledRequest = "NoRequest";
    app.get("/", function (request, response) {
        response.sendFile('views/index.html', {root: __dirname});
    })

    app.post("/led", function (request, response) {
        if (request.body.status) {
            ledRequest = request.body.status;
        }
        else {
            ledRequest = "off";
        }
        response.send("OK");
    })

    app.get("/led", function (request, response) {
        response.send(ledRequest);
        ledRequest = "NoRequest";
    })
    [/code]
</p>

<p>
    <h2>Thiết kế xử lý ESP8266</h2>
    <div>ESP8266 sau khi kết nối vào wifi, sẽ liên tục gửi request tới sever. Khi sever chưa có request, nó sẽ trả về "NoRequest", khi có request on hay off, sever trả về tương ứng.</div>
    [code language="cpp"]
    String address = "http://192.168.1.8/led";
    http.begin(address);    
    int httpCode = http.GET();            
    String payload = http.getString(); 
    if(payload == "on")
    {
        digitalWrite(LED, HIGH);
    }
    else if (payload == "off")
    {
        digitalWrite(LED, LOW);
    }
    delay(1000);
    [/code]
</p>

<p>Phần code mẫu trên đây chỉ bao gồm các method cơ bản, chứ không phải code đầy đủ. Bạn cần thêm css vào website, import các module cần thiết vào phần sever, và hoàn thiện code cho ESP8266 trước khi chạy.
    Kết quả như bên dưới.
</p>

<p>
<h1>Yêu cầu 2</h1>
<div>Mở rộng phần 5 cho nhiều đèn LED</div>
</p>
<p>
    <h2>Trang web</h2>
    Cách 1: Thêm các check box vào form.
    [code language="html"]
    <form action="/led" method="post">
        <p><input type="checkbox" name="led1">Bật LED 1</input></p>
        <p><input type="checkbox" name="led2">Bật LED 2</input></p>
        <p><input type="checkbox" name="led3">Bật LED 3</input></p>
        <p><input type="checkbox" name="led4">Bật LED 4</input></p>
        <p><input type="checkbox" name="led5">Bật LED 5</input></p>
        <p><button type="submit">submit</button></p> 
    </form>
    [/code]
    Như vậy với cách trên, mỗi lần submit ta phải submit cả 5 LED, dù có những Led ta không muốn đổi trạng thái.<br>
    Cách 2: Tạo 5 form thay vì 5 LED.

    [code language="html"]
    <form action="/led/1" method="post">
        <input type="checkbox" >Bật LED 1</input>
        <button type="submit">submit</button>
    </form>
    <form action="/led/2" method="post">
        <input type="checkbox" >Bật LED 2</input>
        <button type="submit">submit</button>
    </form>
    <form action="/led/3" method="post">
        <input type="checkbox" >Bật LED 3</input>
        <button type="submit">submit</button>
    </form>
    <form action="/led/4" method="post">
        <input type="checkbox" >Bật LED 4</input>
        <button type="submit">submit</button>
    </form>
    <form action="/led/5" method="post">
        <input type="checkbox" >Bật LED 5</input>
        <button type="submit">submit</button>
    </form>
    [/code]
    Như vậy, với cách này, ta post tới 5 địa chỉ khác nhau. Vậy có cần tạo 5 method handle POST tương ứng ở sever không?
</p>

<p>
    <h2>Backend</h2>
    Ta xây dựng theo cách số 2.
    Trước tiên cần lưu trạng thái vào 1 array thay vì 1 biến scala như bài 1
    [code (lang='js')]
    var ledRequest = ["NoRequest","NoRequest","NoRequest","NoRequest","NoRequest"];
    [/code]
    Tiếp đó, ta thấy phía client dùng 5 method POST tới 5 địa chỉ gần giống nhau, chỉ khác nhau index phía cuối. Ta có thể dùng <a href="https://www.tutorialspoint.com/expressjs/expressjs_url_building.htm">url building</a> để handle 5 đường dẫn này trong 1 method như sau:
    [code (lang='js')]
    app.post("/led/:id", function (request, response) {    
        var id = parseInt(request.params.id) - 1;  
        if (request.body.status) {
            ledRequest[id] = "on"
        }
        else {
            ledRequest[id] = "off";
        }
    })
    [/code]
    Trong đoạn code trên số 1,2,3,4,5 phía sau được define thành id trong url tới đường link POST /led. để get giá trị trong id ta gọi
    [code (lang='js')]
        request.params.id
    [/code]
    Xử lý trả data về cho ESP8266.
    Ta có thể trả về lần lượt từng LED. 
    [code (lang='js')]
    app.get("/led/:id", function (request, response) {
        var id = parseInt(request.params.id) - 1;  
        response.send(ledRequest[id]);
        ledRequest[id] = "NoRequest";
    })
    [/code]
    hoặc trả về toàn bộ. 
    [code (lang='js')]
    app.get("/led", function (request, response) {
        response.send(ledRequest);
        ledRequest = ["NoRequest", "NoRequest", "NoRequest", "NoRequest", "NoRequest"];
    })
    [/code]
    Tuy nhiên lúc này đoạn payload trả về có dạng <i>["on", "NoRequest", "off", "on", "NoRequest"];</i>. 
    Đoạn string trên rất khó tách ra để xử lý trên code arduino. Vì thế ta cần mã hóa 1 chút.

    [code (lang='js')]
    app.get("/led", function (request, response) {
        var requestStatus = "";
        for (const led of ledRequest) {
            if (led == "on") {
                requestStatus += "1";
            }
            else if (led == "off") {
                requestStatus += "0";
            }
            else{
                requestStatus += "-";
            }
        } 
        response.send(requestStatus);
        ledRequest = ["NoRequest", "NoRequest", "NoRequest", "NoRequest", "NoRequest"];
    })
    [/code]
    Ta tạo chuỗi mới mã hóa lại chuỗi trạng thái Led để xử lý trên arduino cho dễ hơn. <span style="font-family: Courier New; color: #007040;font-weight: bold">0: off, 1: on -: NoRequest</span>
</p>
<p>
    <h2>Code ESP8266</h2>
    Code ESP8266 đơn giản hơn trong trường hợp mã hóa chuỗi trạng thái.
    [code (lang='cpp')]
    void GETMethod()
    {
        Serial.println("Begin Get data");
        String address = "http://192.168.1.8:2383/led";
        http.begin(address);    
        int httpCode = http.GET();            
        String payload = http.getString(); 
        char status[6];
        payload.toCharArray(status, 6, 0);
        for (uint8_t i = 0; i < 5; i++)
        {
            if (status[i] == '1')
            {
                digitalWrite(LEDs[i], HIGH);
            }
            else if(status[i] == '0')
            {
                digitalWrite(LEDs[i], LOW);
            }
        }
    }
    [/code]
</p>

<p>
    <h1>Yêu cầu 3</h1>
    Thêm 1 thiết bị ESP8266 được kết nối với 3 Led đơn, 
    <h2>Phân tích</h2>
    <div>Trước tiên ta đã có 1 device, như vậy khi thêm 1 device với chức năng điều khiển khác ta cần có 1 giao diện điều khiển khác</div>
    <div>Ta có thể trả về giao diện client tương ứng khi encode device name trên url</div>
    <h2>Backend</h2>
    [code (lang='js')]
    var devices = [
        { "name": "device1", "html": "device1.html", "ledRequest": ["NoRequest","NoRequest","NoRequest","NoRequest","NoRequest","NoRequest"]},
        { "name": "device2", "html": "device2.html", "ledRequest": ["NoRequest", "NoRequest", "NoRequest"]},
    ]
    app.get("/:name", function (request, response) {

        var name = request.params.name;  
        var device = getDeviceByName(name);
        response.sendFile('views/' + device.html, {root: __dirname});
    })

    app.post("/led/:name/:id", function (request, response) {    
        var id = parseInt(request.params.id) - 1; 
        var name = request.params.name;
        var device = getDeviceByName(name);
        ledRequest =  device.ledRequest;
        if (request.body.status) {
            ledRequest[id] = "on"
        }
        else {
            ledRequest[id] = "off";
        }
        response.send("Led " + (id + 1) + ": " + ledRequest[id])
    })
    
    app.get("/led/:name", function (request, response) {
        var requestStatus = "";
        var name = request.params.name;
        var device = getDeviceByName(name);
        ledRequest = device.request;
        for (const led of ledRequest) {
            if (led == "on") {
                requestStatus += "1";
            }
            else if (led == "off") {
                requestStatus += "0";
            }
            else{
                requestStatus += "-";
            }
        } 
        response.send(requestStatus);
        ledRequest = ["NoRequest", "NoRequest", "NoRequest", "NoRequest", "NoRequest"];
    })
    [/code]
    <h2>Trang web</h2>
    Thêm chỉ định device vào action.
    [code (lang='html')]
    <form action="/led/device1/1" method="post" autocomplete="off">
        <div>
            <input type="checkbox" checked="checked" name="status[]" class="w3-check" value="0"> 
            <label class="container">Bật LED 1 </label>
            <button type="submit" class="w3-margin-top w3-button w3-border w3-border-blue w3-hover-blue">Submit</button>
        </div>
    </form> 
    [/code]
    <h2>Code ESP8266</h2>
    Thêm chỉ định device vào addres.
    [code (lang='cpp')]
    String address = "http://192.168.1.8:2383/led/device1";
    [/code]
</p>

<h1>Tổng kết</h1>
Qua 3 bài ví dụ ta đã tạo được 1 webserver đơn giản để điều khiển nhiều thiết bị. TUy nhiên ta thấy có những vấn đề sau:
<div style='display: block; padding: 7px; border-left: 5px #22B362 solid; font-family: Courier New;'>
<div>Khi có nhiều device, ta cần tạo nhiều file html khác nhau </div>
<div>Khi submit, trang web điều hướng đến trang khác và khi trở lại, các trạng thái reset </div>
<div>Không cập nhật được trạng thái của device </div>
<div>Device và các trạng thái đang lưu thành biến toàn cục. Cần được lưu vào database </div>
</div>
Những vấn đề trên ta sẽ khắc phục trong các bài kế tiếp, bao gồm template, DOM, ajax, sql.